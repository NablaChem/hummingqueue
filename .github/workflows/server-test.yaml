name: server-test
on: push
jobs:
        test:
                runs-on: ubuntu-latest
                steps:
                        - uses: actions/checkout@v2
                        - name: Build the stack
                          run: |
                                  cd src/server/
                                  docker volume create dev-mongodb
                                  docker volume create dev-minio
                                  docker-compose -f docker-compose.yml -f docker-compose.dev.yml -p dev --env-file env.dev.yml up --build -d
                        - name: Test Server
                          run: |
                                docker exec dev_api_1 pytest --cov=./
                                docker cp dev_api_1:/code/.coverage src/server/api/.coverage
                        - name: Set up Python 3.10
                          uses: actions/setup-python@v4
                          with:
                                python-version: "3.10"
                        - name: Install dependencies
                          run: |
                                python -m pip install --upgrade pip
                                pip install -r src/user/requirements.txt
                        - name: Test User
                          run: |
                                cd src/user/hq
                                pytest --cov=./
                                cd ../../../
                        - name: Combine
                          run: coverage combine  src/user/hq/.coverage src/server/api/.coverage
                        - name: Upload coverage
                          run: |
                                curl -Os https://uploader.codecov.io/v0.1.0_4653/linux/codecov
                                chmod +x codecov
                                ./codecov -t ${{ secrets.CODECOV_TOKEN }}
